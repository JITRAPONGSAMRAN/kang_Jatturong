<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>คำนวณค่าแรง นาย Kang</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
body {
    font-family: sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: auto;
}
table, th, td {
    border: 1px solid #ddd;
    border-collapse: collapse;
}
th, td {
    padding: 8px;
    text-align: center;
}
input[type="number"] {
    width: 70px;
}
button, select, input[type="month"] {
    margin: 10px 5px;
    padding: 5px 10px;
}
tr:nth-child(even) {background: #f2f2f2;}
tr.double-rate { background-color: #ffe0e0; }
tr.absent { background-color: #ddd; }
.total-row { background: #d0f0d0; font-weight: bold; }
@media (max-width: 600px) {
    table, thead, tbody, th, td, tr { display: block; }
    td { text-align: right; padding-left: 50%; position: relative; }
    td:before { content: attr(data-label); position: absolute; left: 0; width: 50%; padding-left: 5px; font-weight: bold; text-align: left; }
    input[type="number"] { width: 100%; }
}
</style>
</head>
<body>
<h1>คำนวณค่าแรง นาย Kang</h1>
<p>ฐานเงินเดือน 600 บาท/วัน (8 ชม.), OT 1.5 เท่า, ติ๊ก "2 เท่า" เพื่อคิดชั่วโมงปกติและ OT คูณ 2</p>

<label>เลือกเดือน: <input type="month" id="monthSelect"></label>
<label>
    งวดเงินเดือน:
    <select id="periodSelect">
        <option value="first">1 - 15 เงินออกวันที่ 20</option>
        <option value="second">16 - สิ้นเดือน เงินออกวันที่ 5 เดือนถัดไป</option>
    </select>
</label>

<button id="exportBtn">Export ข้อมูล</button>
<input type="file" id="importFile" style="display:none">
<button id="importBtn">Import ข้อมูล</button>

<table>
<thead>
<tr><th>วันที่</th><th>ชั่วโมงปกติ</th><th>OT (ชม.)</th><th>2 เท่า</th><th>หยุด</th><th>รวมเงิน</th></tr>
</thead>
<tbody id="workTable"></tbody>
<tfoot>
<tr class="total-row"><td colspan="5">รวมเงินทั้งหมด</td><td id="totalSum">0.00</td></tr>
</tfoot>
</table>

<div id="result" style="margin-top:20px;"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const dailyWage = 600;
    const hoursPerDay = 8;
    const hourlyWage = dailyWage / hoursPerDay;
    const otRate = 1.5;
    const sundayRate = 2;

    const table = document.getElementById("workTable");
    const monthSelect = document.getElementById("monthSelect");
    const periodSelect = document.getElementById("periodSelect");
    const totalSum = document.getElementById("totalSum");
    const result = document.getElementById("result");

    function saveData() {
        const data = [];
        for (let row of table.rows) {
            data.push({
                date: row.dataset.date,
                normalHours: row.querySelector(".normal").value,
                otHours: row.querySelector(".ot").value,
                isDouble: row.querySelector(".double").checked,
                isAbsent: row.querySelector(".absent").checked
            });
        }
        const key = `${monthSelect.value}-${periodSelect.value}`;
        localStorage.setItem(key, JSON.stringify(data));
    }

    function loadData() {
        const key = `${monthSelect.value}-${periodSelect.value}`;
        const saved = localStorage.getItem(key);
        if (saved) {
            const data = JSON.parse(saved);
            data.forEach((d, i) => {
                if (table.rows[i]) {
                    table.rows[i].querySelector(".normal").value = d.normalHours;
                    table.rows[i].querySelector(".ot").value = d.otHours;
                    table.rows[i].querySelector(".double").checked = d.isDouble;
                    table.rows[i].querySelector(".absent").checked = d.isAbsent;
                }
            });
        }
        calculate();
    }

    function generateTable(startDay, endDay, month, year) {
        table.innerHTML = "";
        for (let day = startDay; day <= endDay; day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const date = new Date(dateStr);
            if (isNaN(date)) continue;

            const row = document.createElement("tr");
            row.dataset.date = dateStr;
            row.innerHTML = `
                <td>${new Date(dateStr).toLocaleDateString("th-TH", { year: "numeric", month: "2-digit", day: "2-digit" })}</td>
                <td><input class="normal" type="number" min="0" max="8" value="8"></td>
                <td><input class="ot" type="number" min="0" value="2"></td>
                <td><input class="double" type="checkbox"></td>
                <td><input class="absent" type="checkbox"></td>
                <td class="sumCell">0.00</td>
            `;
            table.appendChild(row);
        }
    }

    function calculate() {
        let total = 0;
        for (let row of table.rows) {
            const normal = parseFloat(row.querySelector(".normal").value) || 0;
            const ot = parseFloat(row.querySelector(".ot").value) || 0;
            const isDouble = row.querySelector(".double").checked;
            const isAbsent = row.querySelector(".absent").checked;

            const rate = isDouble ? sundayRate : 1;
            const normalPay = isAbsent ? 0 : (normal / hoursPerDay) * dailyWage * rate;
            const otPay = isAbsent ? 0 : ot * hourlyWage * (isDouble ? sundayRate : otRate);

            const sum = normalPay + otPay;
            row.querySelector(".sumCell").innerText = sum.toFixed(2);

            row.className = isAbsent ? "absent" : isDouble ? "double-rate" : "";

            total += sum;
        }
        totalSum.innerText = total.toFixed(2);
        saveData();
    }

    document.getElementById("exportBtn").onclick = () => {
        const key = `${monthSelect.value}-${periodSelect.value}`;
        const data = localStorage.getItem(key);
        if (data) {
            const blob = new Blob([data], {type: "application/json"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${key}.json`;
            link.click();n        }
    };

    document.getElementById("importBtn").onclick = () => document.getElementById("importFile").click();

    document.getElementById("importFile").onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const key = `${monthSelect.value}-${periodSelect.value}`;
            localStorage.setItem(key, reader.result);
            loadData();
        };
        reader.readAsText(file);
    };

    monthSelect.onchange = periodSelect.onchange = () => {
        const [year, month] = monthSelect.value.split("-").map(Number);
        if (periodSelect.value === "second") {
            generateTable(16, new Date(year, month, 0).getDate(), month, year);
        } else {
            generateTable(1, 15, month, year);
        }
        loadData();
    };

    table.addEventListener("input", calculate);
    table.addEventListener("change", calculate);

    const today = new Date();
    monthSelect.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    monthSelect.dispatchEvent(new Event("change"));
});
</script>
</body>
</html>
